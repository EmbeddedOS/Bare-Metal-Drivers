# Low Power Modes

## 1. MCU low power mode introduction

- A number of low-power features are available in the Cortex-Mx processor.
- In addition, micro-controller vendors usually also implement a number of low power modes in their Cortex-Mx-based micro-controllers. This we call as device specific low power modes or features.
- Details for micro-controller specific low-power features are usually available in user manuals or application notes available from micro-controller vendor websites.

- MCU low power modes:
  - A Micro controller can be in Run mode or in Low Power mode.
  - In run mode the processor will be clocked and it will be doing its normal operation and it will be consuming the power for its operation.
  - When processor has got nothing to do, you can send it to low power mode otherwise it will be in busy idle loop wasting CPU cycles.

- Low power modes divided into two categories:
  - Processor Specific LP modes.
  - Vendor specific (MCU) LP modes (Ex ST).

## 2. Processor specific low-power modes

- there are two types of sleep mode:
  - 1. SLEEP-DEEP feature is RESET: **Normal** sleep.
    - Instruction: WFI and WFE.
    - Feature: Sleep on exit.
  - 2. SLEEP_DEEP feature is SET: **Deep** sleep.
    - Instruction: WFI and WFE.
    - Feature: Sleep on exit.

- For example, if SLEEP-DEEP bit is set, and you call WFI or WFE instructions. The CPU will go to deep sleep mode.

### 2.1. Normal sleep vs deep sleep

- Inside the processor, the selection between normal sleep mode and deep sleep mode is defined by the SLEEP-DEEP bit in the **System Control Register**.
- Normal sleep mode stops the processor clock.
- Deep sleep stops the system clock and switches off the PLL and flash memory.
- The exact behavior of Normal and Deep Sleep mode is micro-controller vendor specific.

- SYSCLK System clock can get clock from one of three source:
  - PLL
  - HSI
  - HSE
- You can also turn off the PLL engine, if you don't want, so then the system clock will be generated by either HSI or from HSE.

- The system clock is used to derive clock for various other domains like AHB domain, AHB2 domain, APB1 domain, APB2 domain, clocks to Ethernet, clocks to the processor, etc.
- The processor clock is **FCLK Cortex Clock**.

- In Normal Sleep, this clock that is processor will be withdrawn from processor. That means, your **processor will not be clocked** at all but **clocks to other domains will be alive**.
  - For example, clocks to APB1 domain will be alive, APB2 domain will be alive, AHB domain will be alive and clocks to various memories like flash memory, SRAM memories are also alive.

- In deep sleep mode, main PLL engine will be switched off. That means, the whole system clock is switched off. So the system clock will be not alive.
  - That is why, the clocks to various domain like AHB domain, APB domain will be withdrawn and most of the peripherals including the flash and SRAM memories are not functional. So that's the difference between normal sleep and deep sleep mode.

## 3. Entering normal mode and deep sleep modes

- How to enter normal sleep mode:
  - 1. SLEEP-DEEP bit (SCB) of the ARM Cortex Mx processor must be reset.
  - 2. Use instructions like WFI (Wait for interrupt) or WFE (Wait for an event) to trigger entering the sleep mode.
  - 3. You can also use SLEEP-ON-EXIT feature of the ARM cortex Mx Processor to enter in to sleep mode.

- How to enter deep sleep mode:
  - 1. SLEEP-DEEP bit (SCB) of the ARM Cortex Mx processor must be set.
  - 2. Use instructions like WFI or WFE to trigger entering the sleep mode.
  - 3. You can also use SLEEP-ON-EXIT feature of the ARM cortex Mx Processor to enter in to sleep mode.

- Summary: Entering Low power mode
  - In ARM cortex Mx based processor there are only 3 ways by which you can make processor enter in to the low power mode:
    - 1. Execution WFE instruction.
    - 2. Execution WFI instruction.
    - 3. Using the Sleep-On-Exit feature.

- If you enable the sleep on exit the processor enters sleep automatically when it exits ISR.

## 4. Entering sleep mode using Sleep-On-Exit

- It is a feature given by the ARM cortex Mx processor.
- Remember its not an instruction.
- When this feature is enabled, the processor automatically enters a sleep mode when exiting an exception handler, if no other exception waiting to be processed.
- It does not cause the processor to enter sleep if the exception handler is returning to another exception handler (nested interrupt).

- When to use this?
  - When your application does all its work in interrupt handler, then while exiting ISR the processor will automatically go to sleep if you enable this feature to save power.
    - You would like to use this when processor runs only when an interrupt service require servicing.
    - Interrupt driven applications to stay in sleep mode as often as possible.
    - The Sleep-On-Exit feature is ideal for interrupt-driven applications.

- Entering SLEEP mode using Sleep-on-Exit feature:
  - SLEEPONEXIT bit in SCR of the ARM cortex Mx Processor has to be set after all the initialization of your application.
  - No instruction is need to enter sleep mode with this feature enabled.
  - When ISR finishes executing all the instructions you have written, processor goes into sleep mode automatically without returning back to thread mode (No thread related un-stacking happens, because processor is not going back to thread mode).

- NOTE: In interrupt-driven applications, **do not enable Sleep-On-Exit feature too early** during the initialization. Otherwise if the processor receives an interrupt request during the initialization process, it will enter sleep automatically after the interrupt handler executed, before the rest of the initialization process completes.

## 5. Waking up from SLEEPONEXIT

- When the processor enters sleep mode using the SLEEPONEXIT feature or executing WFI instruction, the processor stops instruction execution, enters sleep mode and wakes up when a higher priority interrupt request arrives and needs to be serviced. (This what ARM says, but MCU vendor may implement wake up procedure differently, e.g in ST's Case processor wakes up for any interrupt, i.e priority don't care).

- If the processor enters sleep in an exception handler, and if the newly arrived interrupt request has the same or lower priority compared to the current exception, the processor will not wake up and interrupt will remain in pending state.

- The processor can also be woken up by a halt request from the debugger or by reset.

## 6. Example

- Write an application in which TIM6 triggers, update interrupt for every 10ms and in the ISR of TIM6 send some data over UART2.
- Measure the current consumption without sleep mode.
- Measure the current consumption with sleep mode.

- Reset -> initialization -> enable SLEEPONEXIT feature -> start timer -> wait in while(1) loop -> entry into TIM6 ISR -> UART2 data send -> Exit from ISR -> Sleeping.
